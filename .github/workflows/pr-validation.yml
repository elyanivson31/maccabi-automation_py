name: PR Validation

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main

jobs:
  validate-encryption-setup:
    name: Validate Encryption & Data Loading
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install cryptography
          echo "✓ Dependencies installed"

      - name: Verify encrypted file exists
        run: |
          if [ ! -f "test_data.json.enc" ]; then
            echo "❌ Error: test_data.json.enc not found!"
            exit 1
          fi
          echo "✓ Encrypted file exists"

      - name: Verify test_data.json is in .gitignore
        run: |
          if ! grep -q "test_data.json" .gitignore; then
            echo "❌ Error: test_data.json not in .gitignore!"
            exit 1
          fi
          echo "✓ test_data.json is in .gitignore"

      - name: Verify test_data.json is NOT committed
        run: |
          if git ls-files | grep -q "^test_data.json$"; then
            echo "❌ Error: test_data.json should not be committed to git!"
            echo "   Only test_data.json.enc should be committed."
            exit 1
          fi
          echo "✓ test_data.json is not committed (correct)"

      - name: Run encryption verification tests
        env:
          TEST_DATA_ENCRYPTION_KEY: ${{ secrets.TEST_DATA_ENCRYPTION_KEY }}
        run: |
          if [ -z "$TEST_DATA_ENCRYPTION_KEY" ]; then
            echo "❌ Error: TEST_DATA_ENCRYPTION_KEY secret is not set!"
            echo "   Please add it in GitHub Settings > Secrets > Actions"
            exit 1
          fi
          python verify_encryption.py

      - name: Test DataLoader functionality
        env:
          TEST_DATA_ENCRYPTION_KEY: ${{ secrets.TEST_DATA_ENCRYPTION_KEY }}
        run: |
          if [ -z "$TEST_DATA_ENCRYPTION_KEY" ]; then
            echo "❌ Error: TEST_DATA_ENCRYPTION_KEY secret is not set!"
            echo "   Please add it in GitHub Settings > Secrets > Actions"
            exit 1
          fi
          python -c "
          import sys
          from infra.data_loader import DataLoader

          print('Testing DataLoader with encrypted data...')

          # Test initialization
          loader = DataLoader()
          print('✓ DataLoader initialized')

          # Test contact retrieval
          contacts = loader.data.get('contacts', [])
          if len(contacts) == 0:
              print('❌ Error: No contacts found in test data')
              sys.exit(1)
          print(f'✓ Found {len(contacts)} contacts')

          # Test that we can load at least one contact and it has required fields
          contact_names = [c.get('name') for c in contacts if 'name' in c]
          print(f'✓ Available contacts: {contact_names}')

          # Test loading the first contact
          if contact_names:
              test_contact = loader.get_contact_by_name(contact_names[0])
              required_fields = ['username', 'password']
              for field in required_fields:
                  if field not in test_contact:
                      print(f'❌ Error: Contact missing required field: {field}')
                      sys.exit(1)
              print(f'✓ Contact \"{contact_names[0]}\" loaded successfully with required fields')

          print('✓ All DataLoader tests passed')
          "

  validate-code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Check Python syntax
        run: |
          python -m py_compile infra/*.py
          python -m py_compile tests/*.py
          echo "✓ Python syntax is valid"

      - name: Verify project structure
        run: |
          echo "Checking project structure..."

          # Check required files exist
          required_files=(
            "infra/crypto_utils.py"
            "infra/data_loader.py"
            "setup_encryption.py"
            "verify_encryption.py"
            "SECURITY_SETUP.md"
            ".env.example"
            "test_data.json.enc"
          )

          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "❌ Missing required file: $file"
              exit 1
            fi
            echo "✓ $file exists"
          done

          echo "✓ Project structure is valid"
