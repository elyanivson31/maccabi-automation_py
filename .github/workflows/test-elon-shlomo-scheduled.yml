name: Test Elon Shlomo - Every 5 Minutes

on:
  schedule:
    # Run every 5 minutes (GitHub Actions minimum interval)
    - cron: '*/5 * * * *'
  workflow_dispatch:  # Allow manual triggering

jobs:
  run-test-elon-shlomo:
    runs-on: ubuntu-latest
    timeout-minutes: 10  # Prevent hanging jobs

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Chrome
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: stable

      - name: Verify Chrome installation
        run: |
          which google-chrome-stable
          google-chrome-stable --version

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          echo "âœ“ All dependencies installed"

      - name: Set PYTHONPATH
        run: echo "PYTHONPATH=$(pwd)" >> $GITHUB_ENV

      - name: Verify encrypted test data exists
        run: |
          if [ ! -f "test_data.json.enc" ]; then
            echo "âŒ Error: test_data.json.enc not found!"
            exit 1
          fi
          echo "âœ“ Encrypted test data file exists"

      - name: Verify encryption key is set
        env:
          TEST_DATA_ENCRYPTION_KEY: ${{ secrets.TEST_DATA_ENCRYPTION_KEY }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHANNEL_ID: ${{ secrets.TELEGRAM_CHANNEL_ID }}
        run: |
          if [ -z "$TEST_DATA_ENCRYPTION_KEY" ]; then
            echo "âŒ Error: TEST_DATA_ENCRYPTION_KEY secret is not set!"
            exit 1
          fi
          echo "âœ“ Encryption key is configured"

          if [ -z "$TELEGRAM_BOT_TOKEN" ]; then
            echo "âš ï¸ Warning: TELEGRAM_BOT_TOKEN not set - notifications will fail"
          fi

          if [ -z "$TELEGRAM_CHANNEL_ID" ]; then
            echo "âš ï¸ Warning: TELEGRAM_CHANNEL_ID not set - notifications will fail"
          fi

      - name: Run test_elon_shlomo
        id: run_test
        continue-on-error: true
        env:
          TEST_DATA_ENCRYPTION_KEY: ${{ secrets.TEST_DATA_ENCRYPTION_KEY }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHANNEL_ID: ${{ secrets.TELEGRAM_CHANNEL_ID }}
        run: |
          echo "ðŸš€ Running test_elon_shlomo..."
          echo "Run time: $(date '+%Y-%m-%d %H:%M:%S UTC')"

          # Run the specific test
          if pytest tests/test_elon_shlomo.py::test_elon_shlomo -v; then
            echo "test_passed=true" >> $GITHUB_OUTPUT
            echo "âœ… TEST PASSED! Appointment found!"
            exit 0
          else
            echo "test_passed=false" >> $GITHUB_OUTPUT
            echo "âŒ Test failed - no appointment found yet"
            exit 1
          fi

      - name: Report test success
        if: steps.run_test.outputs.test_passed == 'true'
        run: |
          echo "ðŸŽ‰ SUCCESS! The test has passed!"
          echo "An appointment was found and Telegram notification was sent."
          echo "You may want to disable this workflow now to stop further checks."

      - name: Report test failure
        if: steps.run_test.outputs.test_passed != 'true'
        run: |
          echo "â³ Test did not pass this time. Will retry in 5 minutes."
          echo "This workflow will continue checking every 5 minutes."

      - name: Upload test results (if available)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ github.run_number }}
          path: |
            *.log
            **/*.log
          retention-days: 7
          if-no-files-found: ignore

  # Job to track how long we've been running
  check-workflow-age:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    steps:
      - name: Check if 24 hours have passed
        run: |
          echo "â° This workflow runs every 5 minutes"
          echo "âš ï¸ Note: After 24 hours (288 runs), consider disabling this workflow if the test hasn't passed"
          echo "To disable: Go to Actions > Test Elon Shlomo - Every 5 Minutes > '...' menu > Disable workflow"
          echo ""
          echo "Current run number: ${{ github.run_number }}"
          echo "Approximate hours running: $(((${{ github.run_number }} * 5) / 60))"
