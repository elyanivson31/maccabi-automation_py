name: Test Get Earlier Appointment - Every 5 Minutes

on:
  schedule:
    # Run every 5 minutes (GitHub Actions minimum interval)
    - cron: '*/5 * * * *'
  workflow_dispatch:  # Allow manual triggering

jobs:
  run-test-get-earlier-appointment:
    runs-on: ubuntu-latest
    timeout-minutes: 10  # Prevent hanging jobs
    permissions:
      actions: write  # Required to disable the workflow
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Chrome
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: stable

      - name: Verify Chrome installation
        run: |
          which google-chrome-stable
          google-chrome-stable --version

      - name: Install video recording dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg
          echo "âœ“ FFmpeg installed for video recording"

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          echo "âœ“ All dependencies installed"

      - name: Set PYTHONPATH
        run: echo "PYTHONPATH=$(pwd)" >> $GITHUB_ENV

      - name: Verify encrypted test data exists
        run: |
          if [ ! -f "test_data.json.enc" ]; then
            echo "âŒ Error: test_data.json.enc not found!"
            exit 1
          fi
          echo "âœ“ Encrypted test data file exists"

      - name: Verify encryption key is set
        env:
          TEST_DATA_ENCRYPTION_KEY: ${{ secrets.TEST_DATA_ENCRYPTION_KEY }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHANNEL_ID: ${{ secrets.TELEGRAM_CHANNEL_ID }}
        run: |
          if [ -z "$TEST_DATA_ENCRYPTION_KEY" ]; then
            echo "âŒ Error: TEST_DATA_ENCRYPTION_KEY secret is not set!"
            exit 1
          fi
          echo "âœ“ Encryption key is configured"

          if [ -z "$TELEGRAM_BOT_TOKEN" ]; then
            echo "âš ï¸ Warning: TELEGRAM_BOT_TOKEN not set - notifications will fail"
          fi

          if [ -z "$TELEGRAM_CHANNEL_ID" ]; then
            echo "âš ï¸ Warning: TELEGRAM_CHANNEL_ID not set - notifications will fail"
          fi

      - name: Setup Xvfb for video recording
        run: |
          # Ensure Xvfb is running on display :99
          sudo apt-get install -y xvfb x11-utils
          Xvfb :99 -screen 0 1920x1080x24 &
          echo $! > /tmp/xvfb_pid
          export DISPLAY=:99
          sleep 2
          echo "âœ“ Xvfb started on display :99 (PID: $(cat /tmp/xvfb_pid))"

      - name: Start video recording
        run: |
          mkdir -p videos
          export DISPLAY=:99

          # Verify display is available
          if ! xdpyinfo -display :99 > /dev/null 2>&1; then
            echo "âŒ Display :99 is not available"
            exit 1
          fi
          echo "âœ“ Display :99 is available"

          # Start ffmpeg recording in the background
          ffmpeg -video_size 1920x1080 -framerate 25 -f x11grab -i :99.0 \
            -codec:v libx264 -preset ultrafast -pix_fmt yuv420p \
            videos/test-recording-${{ github.run_number }}.mp4 \
            > /tmp/ffmpeg.log 2>&1 &
          echo $! > /tmp/ffmpeg_pid
          sleep 2

          # Check if ffmpeg is still running
          if ! kill -0 $(cat /tmp/ffmpeg_pid) 2>/dev/null; then
            echo "âŒ FFmpeg failed to start. Log:"
            cat /tmp/ffmpeg.log
            exit 1
          fi

          echo "ðŸŽ¥ Video recording started (PID: $(cat /tmp/ffmpeg_pid))"

      - name: Run test_get_earlier_appointment
        id: run_test
        continue-on-error: true
        env:
          TEST_DATA_ENCRYPTION_KEY: ${{ secrets.TEST_DATA_ENCRYPTION_KEY }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHANNEL_ID: ${{ secrets.TELEGRAM_CHANNEL_ID }}
          DISPLAY: :99
        run: |
          echo "ðŸš€ Running test_get_earlier_appointment..."
          echo "Run time: $(date '+%Y-%m-%d %H:%M:%S UTC')"

          # Run the specific test
          if pytest tests/test_get_earlier_appointment.py::test_get_earlier_appointment -v; then
            echo "test_passed=true" >> $GITHUB_OUTPUT
            echo "âœ… TEST PASSED! Appointment found!"
            exit 0
          else
            echo "test_passed=false" >> $GITHUB_OUTPUT
            echo "âŒ Test failed - no appointment found yet"
            exit 1
          fi

      - name: Stop video recording
        if: always()
        run: |
          if [ -f /tmp/ffmpeg_pid ]; then
            FFMPEG_PID=$(cat /tmp/ffmpeg_pid)
            echo "ðŸ›‘ Stopping video recording (PID: $FFMPEG_PID)"

            # Check if process is still running
            if kill -0 $FFMPEG_PID 2>/dev/null; then
              kill -INT $FFMPEG_PID || true
              # Wait for ffmpeg to finish encoding
              sleep 5
            else
              echo "âš ï¸ FFmpeg process already stopped"
            fi

            # Verify video was created
            if ls videos/*.mp4 1> /dev/null 2>&1; then
              echo "âœ… Video recording saved:"
              ls -lh videos/
            else
              echo "âŒ No video file found. FFmpeg log:"
              cat /tmp/ffmpeg.log || echo "No ffmpeg log available"
            fi
          else
            echo "âš ï¸ No ffmpeg PID file found"
          fi

      - name: Report test success
        if: steps.run_test.outputs.test_passed == 'true'
        run: |
          echo "ðŸŽ‰ SUCCESS! The test has passed!"
          echo "An appointment was found and Telegram notification was sent."
          echo "This workflow will now be automatically disabled."

      - name: Auto-disable workflow after success
        if: steps.run_test.outputs.test_passed == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "ðŸ›‘ Disabling workflow to stop further scheduled runs..."
          gh workflow disable "test-get-earlier-appointment-scheduled.yml" -R ${{ github.repository }}
          echo "âœ… Workflow disabled successfully!"
          echo "The scheduled runs will stop after this execution."
          echo "You can re-enable it anytime from the Actions tab if needed."

      - name: Report test failure
        if: steps.run_test.outputs.test_passed != 'true'
        run: |
          echo "â³ Test did not pass this time. Will retry in 5 minutes."
          echo "This workflow will continue checking every 5 minutes."

      - name: Upload test video
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-video-${{ github.run_number }}
          path: videos/*.mp4
          retention-days: 30
          if-no-files-found: warn

      - name: Upload test results (if available)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ github.run_number }}
          path: |
            *.log
            **/*.log
          retention-days: 7
          if-no-files-found: ignore

  # Job to track how long we've been running
  check-workflow-age:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    steps:
      - name: Check if 24 hours have passed
        run: |
          echo "â° This workflow runs every 5 minutes"
          echo "âš ï¸ Note: After 24 hours (288 runs), consider disabling this workflow if the test hasn't passed"
          echo "To disable: Go to Actions > Test Get Earlier Appointment - Every 5 Minutes > '...' menu > Disable workflow"
          echo ""
          echo "Current run number: ${{ github.run_number }}"
          echo "Approximate hours running: $(((${{ github.run_number }} * 5) / 60))"
